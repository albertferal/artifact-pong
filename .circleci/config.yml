version: 2.1

orbs:
  sonarcloud: sonarsource/sonarcloud@2.0.0

executors:
  pythonpygame:
    docker:
      - image: feralbert90/pokepong1:latest  # Dockerfile que se necesita de dockerhub

jobs:
  job-tests:
    executor: pythonpygame
    steps:
      - checkout  # Para obtener el código del repositorio
      # Aquí agregamos los pasos para ejecutar tests, linting, análisis estático, etc.
      - run:
          name: Run tests
          command: | 
                    pytest Game/tests
      - run:
          name: Run linting
          command: | 
                    pylint  --exit-zero Game
      - run:
          name: Run code coverage
          command: |
                    coverage run -m pytest Game
                    coverage report -m 
      - store_test_results:
          path: Game/tests/test-results.xml
      - sonarcloud/scan

  job-vulnerability:
    executor: pythonpygame
    steps:
      - checkout
#      - restore_cache:
#          keys:
#            - node-deps-{{ .Branch }}-{{ checksum "npm-shrinkwrap.json" }}
      - run:
          name: Install Node.js and npm
          command: |
            apt-get update
            apt-get install -y nodejs npm
      - run:
          name: Install Snyk
          command: |
            npm install -g snyk
      - run:
         name: Analize with Snyc
         command: |
            export SNYK_TOKEN=$SNYK_TOKEN
            cd Game
            snyk_output=$(snyk code test)
            echo "$snyk_output"
            if echo "$snyk_output" | grep -q 'High severity vulnerabilities found'; then
              echo "Detected high severity vulnerabilities. Failing the build."
              exit 1
            else
              echo "No high severity vulnerabilities found."
            fi
#      - save_cache:
#          paths:
#            - ~/.npm
#          key: node-deps-{{ .Branch }}-{{ checksum "npm-shrinkwrap.json" }}

  job-deployment:
    executor: pythonpygame
    steps:
      - checkout
      - run:
          name: Install zip
          command: |
            apt-get update && apt-get install -y zip
      - run:
          name: Create artifacts directory
          command: mkdir -p artifacts
      - run:
          name: Package artifact
          command: cd Game && zip -r ../artifacts/myapp.zip ./*
#      - run:
#          name: Set Git Identity
#          command: |
#            git config user.email "albertferal@gmail.com"
#            git config user.name "albertferal"
#      - run:
#          name: Publish to GitHub
#          command: |
#            git remote set-url origin https://$GITHUB_TOKEN@github.com/albertferal/artifact-circleci.git
#            git add artifacts/myapp.zip
#            git commit -m "Agregar artefacto myapp.zip"
#            git push origin main

  job-create-kind-cluster:
    docker:
      - image: kindest/node:latest
    steps:
      - checkout
      - run:
          name: Install Kind
          command: |
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.11.1/kind-linux-amd64
            chmod +x ./kind
            mv ./kind /usr/local/bin/kind

      - run:
          name: Create Kubernetes Cluster with Kind
          command: |
            kind create cluster --name=my-kind-cluster --wait=5m

  job-deployment-kubernetes:
    docker:
      - image: alpine:latest
    steps:
      - checkout
      # Instalar y configurar la CLI de kubectl
      - run:
          name: Install kubectl
          command: |
            apk add --no-cache curl
            curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
            chmod +x ./kubectl
            mv ./kubectl /usr/local/bin/kubectl

  job-deploy-helm:
    docker:
      - image: alpine:latest
    steps:
      - checkout
      - run:
          name: Install Helm
          command: |
            apk add --no-cache curl
            curl -fsSLo /tmp/get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
            chmod 700 /tmp/get_helm.sh
            /tmp/get_helm.sh

      - run:
          name: Deploy with Helm
          command: |
            helm upgrade --install my-app ./path_to_your_helm_chart

      - run:
          name: Deploy with ArgoCD
          command: |
            # Utiliza la CLI de ArgoCD para desplegar la aplicación
            # Ejemplo: argocd app create myapp --repo <repo_url> --path <path_to_manifests> --revision <branch> --dest-namespace <namespace>
            # Ten en cuenta que estos comandos son ejemplos, debes adaptarlos a tu configuración específica de ArgoCD y tus manifiestos

workflows:
  workflow-testing:
    jobs:
      - job-tests:
          context: SonarCloud
      - job-vulnerability:
          requires:
            - job-tests
      - job-deployment:
          requires:
            - job-vulnerability
          filters:
            branches:
              only: main
      - job-deployment-kubernetes:
          requires:
            - job-deployment
          filters:
            branches:
              only: main

  workflow-kubernetes-deploy:
      jobs:
        - job-create-kind-cluster

        - job-deployment-kubernetes:
            requires:
              - job-create-kind-cluster

        - job-deploy-helm:
            requires:
              - job-deployment-kubernetes